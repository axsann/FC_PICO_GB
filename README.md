# FC PICO GB

FC PICO 上で動作する Game Boy エミュレーターです。ファミコンの PPU を利用して Game Boy のゲームを表示します。

---

## ⚠️ サウンド機能を使用するには

**サウンド機能を有効にするには、ファミコン ROM の更新が必要です。**

### ROM 更新方法

1. **コントローラの START ボタン**と**ファミコン本体のリセットボタン**を同時に押す
2. ROM 更新モードに入り、自動的に更新が行われます

### オリジナル ROM に戻す方法

1. FC PICO のサンプルゲームを起動する
2. **コントローラの START ボタン**と**ファミコン本体のリセットボタン**を同時に押す

### 互換性について

- サウンド対応 ROM は**下位互換**があります（サウンド非対応のソフトウェアもそのまま動作します）
- ROM 更新後も、GB エミュレータ以外の FC PICO ソフトウェアは正常に動作します

---

## ⚠️ セーブデータについて

**ゲーム内でセーブしただけではデータは保存されません。**

### Arduino IDE 設定（必須）

セーブ機能を使用するには、ビルド時に以下の設定が必要です：

- **Tools → Flash Size**: 「4MB (Sketch: 3.5MB, FS: 512KB)」を選択

### セーブ方法

1. ゲーム内でセーブを行う（通常のセーブ操作）
2. **SELECT + START を同時押し**してフラッシュに保存

### 注意事項

- SELECT + START を押さずに電源を切ると、**セーブデータは失われます**
- 保存中は画面が一瞬乱れますが、これは仕様です
- 保存完了後、画面に「SAVED」と表示されます

---

## オーバークロック設定

60fps の滑らかなエミュレーションを実現するため、CPU を 276MHz にオーバークロックしています。

Arduino IDE で以下の設定が必要です：
- **Tools → CPU Speed**: 「276 MHz (Overclock)」を選択

## 最適化設定（サウンド品質向上）

サウンドをよりスムーズに再生するには、コンパイラ最適化を `-O3` に設定してください。

Arduino IDE で以下の設定が必要です：
- **Tools → Optimize**: 「Optimize More (-O3)」を選択

> **注意**: `-Ofast` は使用しないでください。`-Ofast` は `-ffast-math` を有効にし、IEEE 754 浮動小数点規格に準拠しない最適化を行うため、一部の処理で計算誤差が発生する可能性があります。

## アーキテクチャ

### システム構成

```
┌─────────────────────┐     GPIO/PIO     ┌─────────────────────┐
│   ファミコン本体     │ ◄──────────────► │  Raspberry Pi Pico   │
│   (PPU表示)         │    データ通信     │  (GB エミュレーション) │
└─────────────────────┘                   └─────────────────────┘
```

### ファイル構成

| ファイル | 役割 |
|----------|------|
| `fc_pico_gb.ino` | メインスケッチ、`GB_EMU_MODE` フラグ定義 |
| `ap_core0.h` | Core0 の setup/loop、GB エミュレータ初期化 |
| `rp_gbemu.cpp/h` | Peanut-GB ラッパークラス |
| `ap_gb.cpp/h` | GB 画面ハンドラ（FC への描画処理） |
| `ap_main.cpp/h` | アプリケーション状態管理（`ST_GB` ステート追加） |
| `rp_system.cpp/h` | FC との通信、パレット/属性テーブル管理 |
| `res/gbrom.c` | 埋め込み ROM データ |

### データフロー

**起動時:**
```
fc_pico_gb.ino → ap_core0.h::setup()
    → initGBEmulator()    ... gbrom.c から ROM 読み込み
    → gbemu.init()        ... Peanut-GB 初期化
    → ap.setStep(ST_GB)   ... GB モードに遷移
```

**メインループ (60fps):**
```
ap_core0.h::loop()
    → ap_main::main()     ... ST_GB ステート
    → ap_gb::main()
        ├── gbemu.setJoypad()   ... FC コントローラ入力を GB 形式に変換
        ├── gbemu.runFrame()    ... 1 フレーム分の GB エミュレーション実行
        └── renderToFC()        ... GB 画面を FC 画面に転送
```

### 画面変換

GB 画面 (160x144) を FC 画面 (256x240) の中央に配置します。

```
FC 画面 (256 x 240)
┌────────────────────────────────────┐
│          黒ボーダー (48px)          │
│  ┌────────────────────────────┐   │
│  │                            │   │
│  │     GB 画面 (160 x 144)    │   │
│  │                            │   │
│  └────────────────────────────┘   │
│          黒ボーダー (48px)          │
└────────────────────────────────────┘
```

- **オフセット**: X=48, Y=48
- **パレット**: ゲーム別カラーパレット（GBC Bootstrap ROM 互換）

### コントローラ

FC コントローラをそのまま GB に対応させています。

| FC | GB |
|----|----|
| A | A |
| B | B |
| SELECT | SELECT |
| START | START |
| 十字キー | 十字キー |

### 特殊操作

| 操作 | 機能 |
|------|------|
| SELECT + START | セーブデータをフラッシュに保存 |
| SELECT + LEFT/RIGHT | パレット切り替え（Game → DMG Green → Mono） |

### セーブ機能

**重要: [上記の注意事項](#️-セーブデータについて)を必ずお読みください。**

- 保存中は画面が一瞬乱れますが、これは仕様です（フラッシュ書き込み中の制約）
- 保存完了後、画面に「SAVED」と表示されます
- 「NO FS」が表示される場合は、Arduino IDE の **Tools → Flash Size** で FS 領域を確保してください
- セーブデータは ROM タイトルごとに `/saves/TITLE.sav` に保存されます
- 次回起動時に自動で読み込まれます

### ゲーム別カラーパレット

人気ゲームは専用のカラーパレットで表示されます。

| ゲーム | パレット |
|--------|----------|
| ポケットモンスター 赤 | 赤系 |
| ポケットモンスター 青 | 青系 |
| ポケットモンスター ピカチュウ | 黄系 |
| テトリス | モノクロ |
| ゼルダの伝説 夢をみる島 | 緑系 |
| 星のカービィ | ピンク系 |

- SELECT + LEFT/RIGHT でパレット切り替え（Game → DMG Green → Mono）
- 上記以外のゲームは DMG Green（クラシック GB 緑）で表示

### サウンド

Game Boy の音声を NES APU で再生します。

| GB チャンネル | NES チャンネル | 備考 |
|---------------|----------------|------|
| Pulse1 | Pulse1 ($4000) | 矩形波、スイープ対応 |
| Pulse2 | Pulse2 ($4004) | 矩形波 |
| Wave | Triangle ($4008) | 三角波で代用 |
| Noise | Noise ($400C) | |

- 各 GB チャンネルは専用の NES チャンネルに 1:1 マッピング
- Wave チャンネルは NES Triangle で出力（任意波形は三角波で近似）
- Pulse/Noise チャンネルは音割れ防止のため音量を 93.75% に制限
- サウンド機能には ROM の更新が必要です（[上記参照](#️-サウンド機能を使用するには)）

## ビルド・実行方法

### 1. Arduino IDE で書き込み

1. Arduino IDE で `fc_pico_gb/fc_pico_gb.ino` を開く
2. ボード設定: Raspberry Pi Pico 2
3. **Tools → Flash Size**: 「4MB (Sketch: 3.5MB, FS: 512KB)」を選択（セーブデータ用、約15個）
   - セーブ領域を多めにしたい場合は「4MB (Sketch: 3MB, FS: 1MB)」を選択（約30個）
4. 画面左上の Upload ボタン (→) または「Sketch」→「Upload」

### 2. FC PICO での実行

1. FC PICO をファミコン本体のカートリッジスロットに挿入
2. ファミコンの電源を入れる
3. Game Boy ゲームが FC の画面に表示される

## ROM について

### 同梱ゲーム

デフォルトで **Tobu Tobu Girl** が `res/gbrom.c` に埋め込まれています。

Tobu Tobu Girl はオープンソースの Game Boy ゲームで、再配布が許可されています。

- **公式サイト**: https://tangramgames.dk/tobutobugirl/
- **GitHub**: https://github.com/SimonLarsen/tobutobugirl
- **著作権者**: Simon Larsen, Lukas Hansen
- **ライセンス**: MIT (ソースコード) / CC-BY 4.0 (アセット)

### 他の ROM を使用する場合

```bash
python3 fc_pico_gb/tools/rom2c.py your_game.gb fc_pico_gb/res/gbrom.c
```

※ 市販ゲームの ROM は各自で用意してください。

## ライセンス

本プロジェクトは **MIT** ライセンスの下で配布されます。

### 使用ライブラリ

| ライブラリ | ライセンス | 著作権者 | 用途 |
|-----------|-----------|---------|------|
| Peanut-GB | MIT | Mahyar Koshkouei | GB エミュレーションコア |
| Tobu Tobu Girl | MIT / CC-BY 4.0 | Simon Larsen, Lukas Hansen | 同梱デモゲーム |

詳細は LICENSE ファイルを参照してください。
